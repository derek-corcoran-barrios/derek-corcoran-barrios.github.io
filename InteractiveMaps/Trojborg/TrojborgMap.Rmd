---
title: "Map Trojborg"
author: "Derek Corcoran"
date: "8/20/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, cache = FALSE)
library(tidyverse)
library(leaflet)
library(sf)
library(raster)

Trojborg <- read_sf("GroupsTrojborg.shp") %>% 
  st_transform(crs = "+proj=longlat +datum=WGS84 +no_defs") %>% 
  mutate(Group = case_when(Group == 1 ~ "A1",
                           Group == 2 ~ "A2",
                           Group == 3 ~ "B1",
                           Group == 4 ~ "B2",
                           Group == 5 ~ "C1",
                           Group == 6 ~ "C2"))

Trojborg_Centroids <- read_sf("Trojborg_centroids.shp") %>% 
  st_transform(crs = "+proj=longlat +datum=WGS84 +no_defs")%>% 
  mutate(Group = case_when(Group == 1 ~ "A1",
                           Group == 2 ~ "A2",
                           Group == 3 ~ "B1",
                           Group == 4 ~ "B2",
                           Group == 5 ~ "C1",
                           Group == 6 ~ "C2"))

Trojborg_Centroids <- Trojborg_Centroids %>% 
  mutate(Code = paste(Group, formatC(rowid, digits = 2, flag = "0"), sep = "_"), Treatment = NA) %>% group_by(Code) %>% group_split()

Treatments <- LETTERS[1:3]

for(i in 1:length(Trojborg_Centroids)){
  set.seed(i)
  Trojborg_Centroids[[i]]$Treatment <- sample(Treatments, replace = F)
}

Trojborg_Centroids <- Trojborg_Centroids %>% reduce(bind_rows) %>% 
  mutate(Code = paste(Code, Treatment, sep = "_")) %>% 
  dplyr::select(-Treatment)

write_sf(Trojborg_Centroids, "Final_Centroids_Trojborg.shp")

Trojborg_Monitor <- read_sf("MonitoringPointsTrojborg.shp") %>%
  st_transform(crs = "+proj=longlat +datum=WGS84 +no_defs")

separated_coord <- Trojborg_Monitor %>% 
  mutate(lat = unlist(map(Trojborg_Monitor$geometry,1)),
         long = unlist(map(Trojborg_Monitor$geometry,2))) %>% 
  as.data.frame() %>% 
  dplyr::select(lat, long)

Trojborg_Monitor <- Trojborg_Monitor %>% cbind(separated_coord)
```

```{r}
l <-leaflet()

esri <- grep("^Esri", providers, value = TRUE)
esri <- esri[c(5,2,4,10)]

pal <- colorFactor(
  palette = c("#9e0142", "#d53e4f", "#fee08b", "#ffffbf", "#66c2a5", "#3288bd"),
  domain= as.character(sort(unique(Trojborg_Centroids$Group))),
  ordered = TRUE,
  na.color = "#808080"
)

for (provider in esri) {
  l <- l %>% addProviderTiles(provider, group = provider)    
}

l <- l %>% 
    leaflet::addCircleMarkers(data = as_Spatial(Trojborg_Monitor), radius = 6, group = "Monitoring", color = ~"white", popup = paste("Lon:", Trojborg_Monitor$long, "<br>",
                           "Lat:", Trojborg_Monitor$lat)) %>% 
    leaflet::addCircleMarkers(data = as_Spatial(Trojborg_Centroids), radius = 6, group = "Points", color = ~pal(Group), popup = paste("Lon:", Trojborg_Centroids$long, "<br>",
                           "Lat:", Trojborg_Centroids$lat, "<br>",
                           "Group:", Trojborg_Centroids$Group, "<br>", 
                           "Code:", Trojborg_Centroids$Code)) %>%
  addPolygons(data = as_Spatial(Trojborg), group = "Groups", color = ~pal(Group), fillColor = ~pal(Group), opacity = 0.8, fillOpacity = 0.8, popup = Trojborg$Group) %>% 
  addLayersControl(baseGroups = names(esri),
                   overlayGroups = c("Points", "Groups", "Monitoring"),
                   options = layersControlOptions(collapsed = TRUE)) %>%
  addMeasure(position = "topleft",
             primaryLengthUnit = "meters",
             primaryAreaUnit = "hectares") %>% 
  hideGroup("Groups")

l %>% addLegend("bottomright", pal = pal ,title = "Trojborg sites",opacity = 1, values = Trojborg_Centroids$Group) %>%
  addEasyButton(easyButton(
    icon="fa-crosshairs", title="Locate Me",
    onClick=JS("function(btn, map){ map.locate({setView: true}); }")))

```
